{% extends "base.html" %}

{% block title %}My Tasks - AgTools{% endblock %}

{% block content %}
<!-- Task Summary Cards -->
<div class="summary-row">
    <div class="summary-card">
        <div class="summary-number">{{ status_counts.todo }}</div>
        <div class="summary-label">To Do</div>
    </div>
    <div class="summary-card">
        <div class="summary-number text-primary">{{ status_counts.in_progress }}</div>
        <div class="summary-label">In Progress</div>
    </div>
    <div class="summary-card">
        <div class="summary-number text-success">{{ status_counts.completed }}</div>
        <div class="summary-label">Completed</div>
    </div>
</div>

<!-- Filter Section -->
<div class="filter-section">
    <form action="/m/tasks" method="GET" class="filter-form">
        <div class="filter-row">
            <select name="status" class="form-select">
                <option value="">All Status</option>
                {% for s in statuses %}
                <option value="{{ s }}" {% if current_status == s %}selected{% endif %}>
                    {{ s | replace('_', ' ') | title }}
                </option>
                {% endfor %}
            </select>
            <select name="priority" class="form-select">
                <option value="">All Priority</option>
                {% for p in priorities %}
                <option value="{{ p }}" {% if current_priority == p %}selected{% endif %}>
                    {{ p | title }}
                </option>
                {% endfor %}
            </select>
            <button type="submit" class="btn btn-secondary btn-sm">Filter</button>
        </div>
    </form>
</div>

<!-- Task List -->
<div class="task-list">
    {% if tasks %}
        {% for task in tasks %}
        <a href="/m/tasks/{{ task.id }}" class="task-card {% if task.is_overdue %}task-overdue{% endif %}">
            <div class="task-header">
                <span class="badge {{ task.priority_class }}">{{ task.priority | upper }}</span>
                <span class="badge {{ task.status_class }}">{{ task.status_label }}</span>
            </div>
            <h3 class="task-title">{{ task.title }}</h3>
            {% if task.description %}
            <p class="task-description">{{ task.description[:100] }}{% if task.description|length > 100 %}...{% endif %}</p>
            {% endif %}
            <div class="task-meta">
                {% if task.due_date %}
                <span class="task-due {% if task.is_overdue %}text-danger{% endif %}">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <polyline points="12 6 12 12 16 14"></polyline>
                    </svg>
                    {% if task.is_overdue %}Overdue: {% endif %}{{ task.due_date }}
                </span>
                {% endif %}
                {% if task.assigned_to_crew_name %}
                <span class="task-crew">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                        <circle cx="9" cy="7" r="4"></circle>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                    </svg>
                    {{ task.assigned_to_crew_name }}
                </span>
                {% endif %}
            </div>
            <div class="task-arrow">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </div>
        </a>
        {% endfor %}
    {% else %}
        <div class="empty-state">
            <div class="empty-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                    <line x1="12" y1="12" x2="12" y2="12"></line>
                </svg>
            </div>
            <h3>No Tasks Found</h3>
            <p>
                {% if current_status or current_priority %}
                    No tasks match your filters. Try changing the filters or view all tasks.
                {% else %}
                    You don't have any assigned tasks right now.
                {% endif %}
            </p>
            {% if current_status or current_priority %}
            <a href="/m/tasks" class="btn btn-primary">View All Tasks</a>
            {% endif %}
        </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Pull-to-refresh functionality
let startY = 0;
let pulling = false;

document.addEventListener('touchstart', (e) => {
    if (window.scrollY === 0) {
        startY = e.touches[0].pageY;
        pulling = true;
    }
});

document.addEventListener('touchmove', (e) => {
    if (!pulling) return;
    const diff = e.touches[0].pageY - startY;
    if (diff > 80) {
        location.reload();
    }
});

document.addEventListener('touchend', () => {
    pulling = false;
});
</script>
{% endblock %}
