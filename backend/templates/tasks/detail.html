{% extends "base.html" %}

{% block title %}{{ task.title }} - AgTools{% endblock %}

{% block content %}
<!-- Back Button -->
<a href="/m/tasks" class="back-link">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
    </svg>
    Back to Tasks
</a>

<!-- Task Header -->
<div class="task-detail-header">
    <div class="task-badges">
        <span class="badge {{ task.priority_class }}">{{ task.priority | upper }}</span>
        <span class="badge {{ task.status_class }}">{{ task.status_label }}</span>
        {% if task.is_overdue %}
        <span class="badge badge-danger">OVERDUE</span>
        {% endif %}
    </div>
    <h1 class="task-detail-title">{{ task.title }}</h1>
</div>

<!-- Task Info Cards -->
<div class="info-cards">
    {% if task.due_date %}
    <div class="info-card {% if task.is_overdue %}info-card-danger{% endif %}">
        <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
            </svg>
        </div>
        <div class="info-content">
            <div class="info-label">Due Date</div>
            <div class="info-value">{{ task.due_date }}</div>
        </div>
    </div>
    {% endif %}

    {% if task.assigned_to_user_name %}
    <div class="info-card">
        <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                <circle cx="12" cy="7" r="4"></circle>
            </svg>
        </div>
        <div class="info-content">
            <div class="info-label">Assigned To</div>
            <div class="info-value">{{ task.assigned_to_user_name }}</div>
        </div>
    </div>
    {% endif %}

    {% if task.assigned_to_crew_name %}
    <div class="info-card">
        <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
        </div>
        <div class="info-content">
            <div class="info-label">Crew</div>
            <div class="info-value">{{ task.assigned_to_crew_name }}</div>
        </div>
    </div>
    {% endif %}

    <div class="info-card">
        <div class="info-icon">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        </div>
        <div class="info-content">
            <div class="info-label">Created</div>
            <div class="info-value">{{ task.created_at[:10] if task.created_at else 'Unknown' }}</div>
        </div>
    </div>
</div>

<!-- Description -->
{% if task.description %}
<div class="detail-section">
    <h2 class="section-title">Description</h2>
    <div class="task-description-full">
        {{ task.description }}
    </div>
</div>
{% endif %}

<!-- Quick Actions -->
{% if can_edit and next_statuses %}
<div class="detail-section">
    <h2 class="section-title">Quick Actions</h2>
    <div class="action-buttons">
        {% for status_value, label, btn_class in next_statuses %}
        <form action="/m/tasks/{{ task.id }}/status" method="POST" class="inline-form">
            <input type="hidden" name="status" value="{{ status_value }}">
            <button type="submit" class="btn {{ btn_class }} btn-block">
                {% if status_value == 'in_progress' %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"></polygon>
                </svg>
                {% elif status_value == 'completed' %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="20 6 9 17 4 12"></polyline>
                </svg>
                {% elif status_value == 'todo' %}
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="1 4 1 10 7 10"></polyline>
                    <path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path>
                </svg>
                {% endif %}
                {{ label }}
            </button>
        </form>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- Time Logging -->
<div class="detail-section">
    <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
        </svg>
        Time Logged
        {% if time_summary and time_summary.total_hours > 0 %}
        <span class="badge badge-info">{{ "%.1f"|format(time_summary.total_hours) }}h</span>
        {% endif %}
    </h2>

    <!-- Log Time Form -->
    {% if can_edit %}
    <form action="/m/tasks/{{ task.id }}/time" method="POST" class="time-form">
        <div class="form-row">
            <div class="form-group form-group-sm">
                <label for="hours">Hours</label>
                <input
                    type="number"
                    id="hours"
                    name="hours"
                    min="0.25"
                    max="24"
                    step="0.25"
                    value="1"
                    required
                    class="form-input"
                >
            </div>
            <div class="form-group form-group-sm">
                <label for="entry_type">Type</label>
                <select id="entry_type" name="entry_type" class="form-select">
                    {% for et in entry_types %}
                    <option value="{{ et }}">{{ et | title }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="form-group">
            <input
                type="text"
                name="notes"
                placeholder="What did you work on? (optional)"
                class="form-input"
                maxlength="500"
            >
        </div>
        <button type="submit" class="btn btn-primary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
            Log Time
        </button>
    </form>
    {% endif %}

    <!-- Time Entries List -->
    {% if time_entries %}
    <div class="time-entries">
        {% for entry in time_entries %}
        <div class="time-entry">
            <div class="time-entry-info">
                <span class="time-hours">{{ "%.1f"|format(entry.hours) }}h</span>
                <span class="time-type badge badge-secondary">{{ entry.entry_type }}</span>
                <span class="time-user">{{ entry.user_name or 'Unknown' }}</span>
                <span class="time-date">{{ entry.work_date }}</span>
            </div>
            {% if entry.notes %}
            <div class="time-notes">{{ entry.notes }}</div>
            {% endif %}
            {% if entry.user_id == user.id %}
            <form action="/m/tasks/{{ task.id }}/time/{{ entry.id }}/delete" method="POST" class="delete-form">
                <button type="submit" class="btn-icon btn-danger-subtle" title="Delete entry">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No time logged yet.</p>
    {% endif %}
</div>

<!-- Photos -->
<div class="detail-section">
    <h2 class="section-title">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
        </svg>
        Photos
        {% if photo_count > 0 %}
        <span class="badge badge-info">{{ photo_count }}</span>
        {% endif %}
    </h2>

    <!-- Photo Upload Form -->
    {% if can_edit %}
    <form action="/m/tasks/{{ task.id }}/photo" method="POST" enctype="multipart/form-data" class="photo-upload-form">
        <label class="photo-btn">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                <circle cx="12" cy="13" r="4"></circle>
            </svg>
            <span>Take or Upload Photo</span>
            <input type="file" name="photo" accept="image/*" capture="environment" class="hidden-input" required>
        </label>
        <input type="hidden" name="latitude" id="photo-lat">
        <input type="hidden" name="longitude" id="photo-lng">
        <div class="form-group">
            <input
                type="text"
                name="caption"
                placeholder="Add a caption (optional)"
                class="form-input"
                maxlength="200"
            >
        </div>
        <button type="submit" class="btn btn-primary btn-sm">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="17 8 12 3 7 8"></polyline>
                <line x1="12" y1="3" x2="12" y2="15"></line>
            </svg>
            Upload Photo
        </button>
    </form>
    {% endif %}

    <!-- Photo Gallery -->
    {% if photos %}
    <div class="photo-gallery">
        {% for photo in photos %}
        <div class="photo-item">
            <a href="/m/uploads/photos/{{ photo.filename }}" target="_blank" class="photo-link">
                <img src="/m/uploads/photos/{{ photo.filename }}" alt="{{ photo.caption or 'Task photo' }}" loading="lazy">
            </a>
            <div class="photo-info">
                <span class="photo-user">{{ photo.user_name or 'Unknown' }}</span>
                {% if photo.caption %}
                <span class="photo-caption">{{ photo.caption }}</span>
                {% endif %}
            </div>
            {% if photo.user_id == user.id %}
            <form action="/m/tasks/{{ task.id }}/photo/{{ photo.id }}/delete" method="POST" class="photo-delete-form">
                <button type="submit" class="btn-icon btn-danger-subtle" title="Delete photo">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </form>
            {% endif %}
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="text-muted">No photos yet.</p>
    {% endif %}
</div>

<!-- Task Metadata -->
<div class="detail-section task-meta-section">
    <div class="meta-row">
        <span class="meta-label">Created by:</span>
        <span class="meta-value">{{ task.created_by_user_name or 'Unknown' }}</span>
    </div>
    <div class="meta-row">
        <span class="meta-label">Last updated:</span>
        <span class="meta-value">{{ task.updated_at[:10] if task.updated_at else 'Unknown' }}</span>
    </div>
    {% if task.completed_at %}
    <div class="meta-row">
        <span class="meta-label">Completed:</span>
        <span class="meta-value">{{ task.completed_at[:10] }}</span>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
// Confirm before status change
document.querySelectorAll('.action-buttons form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const btn = form.querySelector('button');
        const action = btn.textContent.trim();

        // Only confirm for completing
        if (action.includes('Complete')) {
            if (!confirm('Mark this task as complete?')) {
                e.preventDefault();
                return;
            }
        }

        // Disable button to prevent double-submit
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span> Updating...';
    });
});

// GPS capture for photos
if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const latInput = document.getElementById('photo-lat');
            const lngInput = document.getElementById('photo-lng');
            if (latInput) latInput.value = position.coords.latitude;
            if (lngInput) lngInput.value = position.coords.longitude;
        },
        function(error) {
            console.log('GPS not available:', error.message);
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
}

// Photo upload preview and validation
const photoInput = document.querySelector('input[name="photo"]');
if (photoInput) {
    photoInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            // Validate file size (10MB max)
            if (file.size > 10 * 1024 * 1024) {
                alert('File too large. Maximum size is 10 MB.');
                e.target.value = '';
                return;
            }
            // Update button text
            const label = photoInput.closest('.photo-btn');
            if (label) {
                label.querySelector('span').textContent = file.name;
            }
        }
    });
}

// Confirm before photo delete
document.querySelectorAll('.photo-delete-form').forEach(form => {
    form.addEventListener('submit', function(e) {
        if (!confirm('Delete this photo?')) {
            e.preventDefault();
        }
    });
});
</script>
{% endblock %}
